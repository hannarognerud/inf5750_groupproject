{"version":3,"sources":["../../src/api/Api.js"],"names":[],"mappings":"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","file":"Api.js","sourcesContent":["import { checkType } from '../lib/check';\nimport jQuery from '../external/jquery';\nimport System from '../system/System';\n\nfunction getMergeStrategyParam(mergeType = 'REPLACE') {\n    const system = System.getSystem();\n\n    if (system.version && (Number(system.version.minor) <= 22)) {\n        return `mergeStrategy=${mergeType}`;\n    }\n\n    return `mergeMode=${mergeType}`;\n}\n\nfunction processSuccess(resolve) {\n    return (data/* , textStatus, jqXHR */) => {\n        resolve(data);\n    };\n}\n\nfunction processFailure(reject) {\n    return (jqXHR/* , textStatus, errorThrown */) => {\n        if (jqXHR.responseJSON) {\n            return reject(jqXHR.responseJSON);\n        }\n\n        delete jqXHR.then; // eslint-disable-line no-param-reassign\n        return reject(jqXHR);\n    };\n}\n\nfunction getUrl(baseUrl, url) {\n    // If we are dealing with an absolute url use that instead\n    if (new RegExp('^(:?https?:)?//').test(url)) {\n        return url;\n    }\n\n    const urlParts = [];\n\n    if (baseUrl) {\n        urlParts.push(baseUrl);\n    }\n    urlParts.push(url);\n\n    return urlParts.join('/')\n        .replace(new RegExp('(.(?:[^:]))\\/\\/+', 'g'), '$1/')\n        .replace(new RegExp('\\/$'), '');\n}\n\nclass Api {\n    constructor(jquery) {\n        if (!jquery) {\n            throw new Error('D2 requires jQuery');\n        }\n\n        this.jquery = jquery;\n        this.baseUrl = '/api';\n        this.defaultRequestSettings = {\n            headers: {\n                // FIXME: Remove the 'Cache-Control: no-store' header when we figure out how to solve this xhr/jquery bug\n                // does not process consecutive requests for the same url properly due to the 304 response.\n                // It makes no sense to set a 'Cache-Control: no-store' on a request...\n                'Cache-Control': 'no-store',\n            },\n            data: {},\n            contentType: 'application/json',\n            type: undefined,\n            url: undefined,\n        };\n    }\n\n    get(url, data, options) {\n        return this.request('GET', getUrl(this.baseUrl, url), data, options);\n    }\n\n    post(url, data, options) {\n        // Pass data through JSON.stringify, unless options.contentType is 'text/plain' or false (meaning don't process)\n        const\n            payload = (\n                options &&\n                options.contentType !== undefined &&\n                (options.contentType === 'text/plain' || options.contentType === false)\n            ) ? data : JSON.stringify(data);\n        return this.request('POST', getUrl(this.baseUrl, url), payload, options);\n    }\n\n    delete(url, options) {\n        return this.request('DELETE', getUrl(this.baseUrl, url), undefined, options);\n    }\n\n    update(url, data, useMergeStrategy = false) {\n        // Since we are currently using PUT to save the full state back, we have to use mergeMode=REPLACE\n        // to clear out existing values\n        const urlForUpdate = useMergeStrategy === true ? `${url}?${getMergeStrategyParam()}` : url;\n\n        return this.request('PUT', getUrl(this.baseUrl, urlForUpdate), JSON.stringify(data));\n    }\n\n    request(type, url, data, options = {}) {\n        checkType(type, 'string', 'Request type');\n        checkType(url, 'string', 'Url');\n        let requestUrl = url;\n\n        if (data && data.filter) {\n            const urlQueryParams = data.filter\n                // `${str}${separator}${filter}`\n                .reduce((str, filter) => {\n                    const separator = str.length ? '&' : '';\n                    const filterQuery = `filter=${filter}`;\n\n                    return `${str}${separator}${filterQuery}`;\n                }, '');\n\n            delete data.filter; // eslint-disable-line no-param-reassign\n            requestUrl += `?${urlQueryParams}`;\n        }\n\n        const api = this;\n\n        function getOptions(mergeOptions, requestData) {\n            let payload = requestData;\n            if (payload === undefined) {\n                payload = {};\n            } else if (payload === true || payload === false) {\n                payload = payload.toString();\n            }\n\n            const resultOptions = Object.assign({}, api.defaultRequestSettings, mergeOptions);\n\n            resultOptions.type = type;\n            resultOptions.url = requestUrl;\n            resultOptions.data = payload;\n            resultOptions.dataType = options.dataType !== undefined ? options.dataType : 'json';\n            resultOptions.contentType = options.contentType !== undefined ? options.contentType : 'application/json';\n\n            // Only set content type when there is data to send\n            // GET requests and requests without data do not need a Content-Type header\n            // 0 and false are valid requestData values and therefore should have a content type\n            if (type === 'GET' || (!requestData && requestData !== 0 && requestData !== false)) {\n                resultOptions.contentType = undefined;\n            }\n\n            return resultOptions;\n        }\n\n        return new Promise((resolve, reject) => {\n            api.jquery\n                .ajax(getOptions(options, data))\n                .then(processSuccess(resolve), processFailure(reject));\n        });\n    }\n\n    setBaseUrl(baseUrl) {\n        checkType(baseUrl, 'string', 'Base url');\n\n        this.baseUrl = baseUrl;\n\n        return this;\n    }\n}\n\nfunction getApi() {\n    if (getApi.api) {\n        return getApi.api;\n    }\n    return (getApi.api = new Api(jQuery));\n}\n\nApi.getApi = getApi;\n\nexport default Api;\n"]}